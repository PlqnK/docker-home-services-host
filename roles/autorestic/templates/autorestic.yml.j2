version: 2

extras:
  env: &b2_account
    B2_ACCOUNT_ID: '{{ autorestic.b2.account_id }}'
    B2_ACCOUNT_KEY: '{{ autorestic.b2.account_key }}'

global:
  forget:
    keep-daily: 28
    keep-weekly: 8
    keep-monthly: 6
    keep-yearly: 1
  backup:
    exclude-if-present:
      - '.nobackup'

locations:
  documents:
    from: '{{ storage_server_shares_mounts_path }}/backups/documents'
    to: 'b2_documents'
    forget: 'prune'
    options:
      backup:
        exclude:
          - '{{ storage_server_shares_mounts_path }}/backups/documents/immich/encoded-video'
          - '{{ storage_server_shares_mounts_path }}/backups/documents/immich/thumbs'
          - '{{ storage_server_shares_mounts_path }}/backups/documents/nextcloud/files_external'
          - '{{ storage_server_shares_mounts_path }}/backups/documents/nextcloud/appdata_*/preview'
          - '{{ storage_server_shares_mounts_path }}/backups/documents/nextcloud/*/cache'
          - '{{ storage_server_shares_mounts_path }}/backups/documents/nextcloud/*/files_trashbin'
          - '{{ storage_server_shares_mounts_path }}/backups/documents/nextcloud/*/files_versions'
          - '{{ storage_server_shares_mounts_path }}/backups/documents/nextcloud/*/uploads'
          - '*.log'
          - '*.log.[0123456789]'
    hooks:
      before:
        - 'curl -m 10 --retry 5 https://healthchecks.{{ domain_name }}/ping/{{ autorestic.documents.healthchecks_uuid }}/start'
      failure:
        - 'curl -m 10 --retry 5 https://healthchecks.{{ domain_name }}/ping/{{ autorestic.documents.healthchecks_uuid }}/fail'
      success:
        - 'curl -m 10 --retry 5 https://healthchecks.{{ domain_name }}/ping/{{ autorestic.documents.healthchecks_uuid }}'
  groupware:
    from: '{{ storage_server_shares_mounts_path }}/backups/groupware'
    to: 'b2_groupware'
    forget: 'prune'
    hooks:
      before:
        - 'curl -m 10 --retry 5 https://healthchecks.{{ domain_name }}/ping/{{ autorestic.groupware.healthchecks_uuid }}/start'
      failure:
        - 'curl -m 10 --retry 5 https://healthchecks.{{ domain_name }}/ping/{{ autorestic.groupware.healthchecks_uuid }}/fail'
      success:
        - 'curl -m 10 --retry 5 https://healthchecks.{{ domain_name }}/ping/{{ autorestic.groupware.healthchecks_uuid }}'
  medias:
    from:
      - '{{ storage_server_shares_mounts_path }}/medias/audiodrama'
      - '{{ storage_server_shares_mounts_path }}/medias/audiobooks'
      - '{{ storage_server_shares_mounts_path }}/medias/books'
      - '{{ storage_server_shares_mounts_path }}/medias/comics'
    to: 'b2_medias'
    forget: 'prune'
    hooks:
      before:
        - 'curl -m 10 --retry 5 https://healthchecks.{{ domain_name }}/ping/{{ autorestic.medias.healthchecks_uuid }}/start'
      failure:
        - 'curl -m 10 --retry 5 https://healthchecks.{{ domain_name }}/ping/{{ autorestic.medias.healthchecks_uuid }}/fail'
      success:
        - 'curl -m 10 --retry 5 https://healthchecks.{{ domain_name }}/ping/{{ autorestic.medias.healthchecks_uuid }}'
  servers:
    from: '{{ storage_server_shares_mounts_path }}/backups/servers'
    to: 'b2_servers'
    forget: 'prune'
    hooks:
      before:
        - 'curl -m 10 --retry 5 https://healthchecks.{{ domain_name }}/ping/{{ autorestic.servers.healthchecks_uuid }}/start'
      failure:
        - 'curl -m 10 --retry 5 https://healthchecks.{{ domain_name }}/ping/{{ autorestic.servers.healthchecks_uuid }}/fail'
      success:
        - 'curl -m 10 --retry 5 https://healthchecks.{{ domain_name }}/ping/{{ autorestic.servers.healthchecks_uuid }}'

backends:
  b2_documents:
    type: 'b2'
    path: '{{ autorestic.documents.bucket }}'
    key: '{{ autorestic.documents.key }}'
    env:
      <<: *b2_account
  b2_groupware:
    type: 'b2'
    path: '{{ autorestic.groupware.bucket }}'
    key: '{{ autorestic.groupware.key }}'
    env:
      <<: *b2_account
  b2_medias:
    type: 'b2'
    path: '{{ autorestic.medias.bucket }}'
    key: '{{ autorestic.medias.key }}'
    env:
      <<: *b2_account
  b2_servers:
    type: 'b2'
    path: '{{ autorestic.servers.bucket }}'
    key: '{{ autorestic.servers.key }}'
    env:
      <<: *b2_account
