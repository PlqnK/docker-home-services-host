---
- name: 'Configure TOTP settings for the admin user'
  ansible.builtin.template:
    src: 'google-authenticator.j2'
    dest: '/home/{{ admin_user.name }}/.ssh/.google_authenticator'
    owner: '{{ admin_user.name }}'
    group: '{{ admin_user.name }}'
    mode: '0400'
    # The PAM module adds information in the file when used so this task won't be idempotent.
    # So we disable templating if the file already exists. If the TOTP secret needs to be changed, the file will need to be deleted manually.
    force: false

- name: 'Enable password and challenge response authentication for SSH connections'
  ansible.builtin.copy:
    content: '{{ item.content }}'
    dest: '/etc/ssh/sshd_config.d/{{ item.file }}'
    owner: 'root'
    group: 'root'
    mode: '0644'
  loop:
    - content: 'PasswordAuthentication yes'
      file: '02-enable-passwords.conf'
    - content: 'ChallengeResponseAuthentication yes'
      file: '03-enable-totp.conf'
  notify: 'Restart sshd service'

- name: 'Enable google-authenticator PAM module for SSH connections'
  ansible.builtin.lineinfile:
    path: '/etc/pam.d/sshd'
    search_string: 'pam_google_authenticator.so'
    line: 'auth       required     pam_google_authenticator.so secret=/home/${USER}/.ssh/.google_authenticator'
    state: 'present'
  notify: 'Restart sshd service'
