[Unit]
Description=Plex Media Server
Documentation=man:podman-systemd.unit(5)
Wants=network-online.target
After=network-online.target

[Container]
ContainerName=plex
Image={{ containers_images.plex }}:{{ containers_images_tags.plex }}
Network=plex-external
Network=common-internal
PublishPort=32400:32400/tcp
PublishPort=32410-32414:32410-32414/udp
AddDevice=/dev/dri/card1:/dev/dri/card1
AddDevice=/dev/dri/renderD128:/dev/dri/renderD128
Volume={{ containers_storage_path }}/data/plex:/config:Z
Volume={{ containers_storage_path }}/runtime/plex:/transcode:Z
Volume={{ nfs_mounts_path }}/medias/audiobooks:/data/audiobooks:slave,ro
Volume={{ nfs_mounts_path }}/medias/audiodrama:/data/audiodrama:slave,ro
Volume={{ nfs_mounts_path }}/medias/movies:/data/movies:slave,ro
Volume={{ nfs_mounts_path }}/medias/music:/data/music:slave,ro
Volume={{ nfs_mounts_path }}/medias/series:/data/series:slave,ro
Timezone={{ timezone }}
Environment="TZ={{ timezone }}"
Environment="PLEX_CLAIM={{ plex.claim_token }}"
Label="traefik.enable=true"
Label="traefik.docker.network=common-internal"
Label="traefik.http.routers.plex.rule=Host(`plex.{{ domain_name }}`)"
Label="traefik.http.routers.plex.entrypoints=websecure"
Label="traefik.http.routers.plex.middlewares=set-security-headers@file"
Label="traefik.http.services.plex.loadbalancer.server.port=32400"
Label="traefik.http.services.plex.loadbalancer.server.scheme=https"

[Service]
Restart=on-failure
TimeoutStopSec=70

[Install]
WantedBy=default.target
