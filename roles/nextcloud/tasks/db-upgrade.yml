---
- name: 'Stop Nextcloud stack except PostgreSQL'
  ansible.builtin.systemd:
    name: '{{ item }}'
    state: 'stopped'
  loop:
    - 'nextcloud-postgres-dump.timer'
    - 'nextcloud-cron.timer'
    - 'nextcloud-server.service'
    - 'nextcloud-redis.service'

- name: 'Dump Nextcloud database'
  ansible.builtin.command:
    cmd: 'podman exec nextcloud-postgres pg_dump -U {{ nextcloud.postgres.user }} -d {{ nextcloud.postgres.database }} --clean --if-exists -f /opt/dumps/nextcloud.sql'

- name: 'Stop PostgreSQL'
  ansible.builtin.systemd:
    name: 'nextcloud-postgres.service'
    state: 'stopped'

- name: 'Create {{ containers_storage_path }} btrfs snapshot'
  community.general.btrfs_subvolume:
    name: '.snapshot'
    filesystem_label: '{{ containers_storage_path | dirname }}'
    snapshot_source: '{{ containers_storage_path }}'
    snapshot_conflict: 'clobber'

- name: 'Remove PostgreSQL runtime directory'
  ansible.builtin.file:
    path: '{{ containers_storage_path }}/runtime/nextcloud-postgres'
    state: 'absent'

- name: 'Recreate PostgreSQL runtime directory'
  ansible.builtin.file:
    path: '{{ containers_storage_path }}/runtime/nextcloud-postgres'
    owner: 999
    group: 999
    mode: '0700'
    state: 'directory'

- name: 'Update PostgreSQL tag in quadlet unit'
  ansible.builtin.template:
    src: 'nextcloud-postgres.container.j2'
    dest: '/etc/containers/systemd/nextcloud-postgres.container'
    owner: 'root'
    group: 'root'
    mode: '0644'

- name: 'Start PostgreSQL'
  ansible.builtin.systemd:
    name: 'nextcloud-postgres.service'
    daemon_reload: true
    state: 'started'

- name: 'Restore Nextcloud database'
  ansible.builtin.command:
    cmd: 'podman exec nextcloud-postgres psql -U {{ nextcloud.postgres.user }} -d {{ nextcloud.postgres.database }} -f /opt/dumps/nextcloud.sql'

- name: 'Enable and start Nextcloud stack'
  ansible.builtin.systemd:
    name: '{{ item }}'
    enabled: true
    state: 'started'
  loop:
    - 'nextcloud-postgres.service'
    - 'nextcloud-redis.service'
    - 'nextcloud-server.service'
    - 'nextcloud-cron.timer'
    - 'nextcloud-postgres-dump.timer'
