[Unit]
Description=Immich Microservices
Documentation=man:podman-systemd.unit(5)
Wants=network-online.target
After=network-online.target
After=immich-postgres.service immich-redis.service immich-typesense.service immich-machine-learning.service
Requires=immich-postgres.service immich-redis.service immich-typesense.service immich-machine-learning.service

[Container]
ContainerName=immich-microservices
Image={{ containers_images.immich.server }}:{{ containers_images_tags.immich.server }}
Exec=start.sh microservices
Network=web-egress
Network=immich-server-internal
Network=immich-typesense-internal
Network=immich-redis-internal
Network=immich-postgres-internal
ExposeHostPort=3002
Volume={{ volume_mount_path }}/documents/immich:/usr/src/app/upload:z
Secret=immich_postgres_user
Secret=immich_postgres_password
Secret=immich_redis_password
Timezone={{ timezone }}
EnvironmentFile={{ containers_storage_path }}/env/immich-server/immich-server.env
Environment="TZ={{ timezone }}"
Environment="DB_HOSTNAME=immich-postgres"
Environment="DB_DATABASE_NAME={{ immich.postgres.database }}"
Environment="DB_USERNAME_FILE=/run/secrets/immich_postgres_user"
Environment="DB_PASSWORD_FILE=/run/secrets/immich_postgres_password"
Environment="REDIS_HOSTNAME=immich-redis"
Environment="REDIS_PASSWORD_FILE=/run/secrets/immich_redis_password"
Environment="TYPESENSE_HOST=immich-typesense"
Environment="UPLOAD_LOCATION=/usr/src/app/upload"
Environment="IMMICH_SERVER_URL=http://immich-server:3001"
Environment="IMMICH_MACHINE_LEARNING_URL=http://immich-machine-learning:3003"

[Service]
Restart=on-failure
TimeoutStopSec=70

[Install]
WantedBy=default.target
