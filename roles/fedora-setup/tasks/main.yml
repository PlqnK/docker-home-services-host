---
- name: Ensure SELinux is enabled
  selinux:
    policy: targeted
    state: enforcing

- name: Ensure firewalld is enabled and running
  systemd:
    name: firewalld
    state: started
    enabled: yes

- name: Upgrade all packages
  dnf:
    name: '*'
    state: latest

- name: Install needed packages
  dnf:
    name:
      - dnf-plugins-core
      - htop
      - wget
      - curl
      - vim
      - git
      - nfs-utils
      - autofs
      - rsync
      - rsync-daemon
      - moby-engine
    state: present

- name: Enable and start the docker service
  systemd:
    name: docker
    state: started
    enabled: yes

- name: Add main user to docker group
  user:
    name: "{{ main_user }}"
    groups: docker
    append: yes

# Configure firewalld to work with docker (allow inter-container communication on port 443)
# See here for more information: https://opsech.io/posts/2017/May/23/docker-dns-with-firewalld-on-fedora.html
- name: Create firewalld docker zone
  firewalld:
    zone: docker
    state: present
    permanent: yes
  register: docker_zone_created

- name: Reload firewalld
  # See the notes on zone transaction https://docs.ansible.com/ansible/latest/modules/firewalld_module.html
  command: firewalld-cmd --reload
  when: docker_zone_created.changed

- name: Add interface to firewalld docker zone
  firewalld:
    zone: docker
    interface: docker0
    permanent: yes
    immediate: yes
    state: enabled

- name: Add source to firewalld docker zone
  firewalld:
    zone: docker
    source: 172.16.0.0/12
    permanent: yes
    immediate: yes
    state: enabled

- name: Add TCP port to firewalld docker zone
  firewalld:
    zone: docker
    service: https
    permanent: yes
    immediate: yes
    state: enabled

- name: Restart Docker
  systemd:
    name: docker
    state: restarted

- name: Create Docker Rutime group
  group:
    name: "{{ docker_runtime_group_name }}"
    gid: "{{ docker_runtime_group_id }}"
    state: present

- name: Create a Docker Runtime user
  user:
    name: "{{ docker_runtime_user_name }}"
    comment: Docker Runtime user
    uid: "{{ docker_runtime_user_id }}"
    group: "{{ docker_runtime_group_name }}"
    create_home: no
    home: /nonexistent
    shell: /usr/sbin/nologin

- name: Create NFS mount points
  file:
    path: "{{ nfs_mount_points }}"
    state: directory
    owner: root
    group: root
    mode: 0755

- name: Create AutoFS master file from template
  template:
    src: server.autofs.j2
    dest: "/etc/auto.master.d/{{ storage_server_name }}.autofs"
    owner: root
    group: root
    mode: 0644

- name: Create AutoFS template file from template
  template:
    src: auto.server.j2
    dest: "/etc/auto.{{ storage_server_name }}"
    owner: root
    group: root
    mode: 0644

- name: Enable and start the autofs service
  systemd:
    name: autofs
    state: started
    enabled: yes

- name: Create local directory for container config files structure
  file:
    path: "{{ local_container_storage_path }}"
    state: directory
    owner: "{{ docker_runtime_user_name }}"
    group: "{{ docker_runtime_group_name }}"
    mode: 0755

- name: Create rsyncd config file from template
  template:
    src: rsyncd.conf.j2
    dest: /etc/rsyncd.conf
    owner: root
    group: root
    mode: 0644

- name: Create rsyncd secrets file from template
  template:
    src: rsyncd.secrets.j2
    dest: /etc/rsyncd.secrets
    owner: root
    group: root
    mode: 0600

- name: Enable and start the rsyncd service
  systemd:
    name: rsyncd
    state: started
    enabled: yes
