---
- name: 'Check if SELinux is configured to allow the use of OpenVPN in containers'
  ansible.builtin.shell:
    cmd: 'semodule -l | grep docker-openvpn'
  register: docker_openvpn_semodule
  changed_when: false
  # grep returns 1 if the string isn't found and 2 for exceptions so we need to change the task fail condition.
  failed_when: docker_openvpn_semodule.rc == 2
  check_mode: false

- name: 'Configure SELinux to allow the use of OpenVPN in containers'
  block:
    - name: 'Copy the SELinux custom policy on the host'
      ansible.builtin.copy:
        src: 'docker-openvpn.te'
        dest: '/tmp/docker-openvpn.te'
        owner: 'root'
        group: 'root'
        mode: '0644'

    - name: 'Compile the SELinux custom policy module'
      ansible.builtin.command:
        cmd: 'checkmodule -M -m -o /tmp/docker-openvpn.mod /tmp/docker-openvpn.te'
      args:
        creates: '/tmp/docker-openvpn.mod'

    - name: 'Package the SELinux custom policy module'
      ansible.builtin.command:
        cmd: 'semodule_package -o /tmp/docker-openvpn.pp -m /tmp/docker-openvpn.mod'
      args:
        creates: '/tmp/docker-openvpn.pp'

    - name: 'Install the SELinux custom policy module'
      ansible.builtin.command:
        cmd: 'semodule -i /tmp/docker-openvpn.pp'
  when: docker_openvpn_semodule.rc == 1
