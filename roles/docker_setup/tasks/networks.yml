---
- name: 'Create external networks (IPv4 only)'
  community.docker.docker_network:
    name: '{{ item }}'
  loop:
    - 'traefik-external'
    - 'plex-external'
    - 'web-egress'
    - 'vpn-tunnel'
  when: not docker_ipv6.enabled

- name: 'Create external networks (IPv4+IPv6)'
  community.docker.docker_network:
    name: '{{ item.name }}'
    enable_ipv6: true
    ipam_config:
      - subnet: '{{ item.subnet }}'
  loop:
    - name: 'traefik-external'
      subnet: '{{ docker_ipv6.ula.prefix }}:1::{{ docker_ipv6.ula.prefix_length }}'
    - name: 'plex-external'
      subnet: '{{ docker_ipv6.ula.prefix }}:2::{{ docker_ipv6.ula.prefix_length }}'
    - name: 'web-egress'
      subnet: '{{ docker_ipv6.ula.prefix }}:3::{{ docker_ipv6.ula.prefix_length }}'
    - name: 'vpn-tunnel'
      subnet: '{{ docker_ipv6.ula.prefix }}:4::{{ docker_ipv6.ula.prefix_length }}'
  when: docker_ipv6.enabled

# I've had problems with inter-containers network communication using IPv6 and we don't really care about it here if
# the only thing we want is our services being accessible using IPv6 from the outside.
- name: 'Create internal networks'
  community.docker.docker_network:
    name: '{{ item }}'
    internal: true
  loop:
    - 'socket-proxy'
    - 'traefik-internal'
    - 'nextcloud-internal'
    - 'photoprism-internal'
    - 'ttrss-internal'

- name: 'Refresh ansible_facts'
  ansible.builtin.gather_facts:

# Docker is supposed to add the networks bridges to the firewalld docker zone on creation and startup dynamically but
# for tome reason on my machine it only add 4 of them. So this task add them manually.
- name: 'Add docker bridges to firewalld docker zone'
  ansible.posix.firewalld:
    zone: docker
    interface: '{{ item }}'
    permanent: true
    immediate: true
    state: 'enabled'
  loop: '{{ ansible_facts.interfaces }}'
  when: (item.startswith("br-"))
