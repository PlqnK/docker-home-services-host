---
- name: 'Check if SELinux is configured to allow the use of TUN in containers'
  ansible.builtin.shell:
    cmd: 'semodule -l | grep container-tun'
  register: container_tun_semodule
  changed_when: false
  # grep returns 1 if the string isn't found and 2 for exceptions so we need to change the task fail condition.
  failed_when: (container_tun_semodule.rc == 2)
  check_mode: false

- name: 'Configure SELinux to allow the use of TUN in containers'
  when: (container_tun_semodule.rc == 1)
  block:
    - name: 'Copy the SELinux custom policy on the host'
      ansible.builtin.copy:
        src: 'container-tun.te'
        dest: '/tmp/container-tun.te'
        owner: 'root'
        group: 'root'
        mode: '0644'

    - name: 'Compile the SELinux custom policy module'
      ansible.builtin.command:
        cmd: 'checkmodule -M -m -o /tmp/container-tun.mod /tmp/container-tun.te'
      args:
        creates: '/tmp/container-tun.mod'

    - name: 'Package the SELinux custom policy module'
      ansible.builtin.command:
        cmd: 'semodule_package -o /tmp/container-tun.pp -m /tmp/container-tun.mod'
      args:
        creates: '/tmp/container-tun.pp'

    - name: 'Install the SELinux custom policy module' # noqa: no-changed-when
      ansible.builtin.command:
        cmd: 'semodule -i /tmp/container-tun.pp'
