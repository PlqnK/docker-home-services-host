---
- name: 'Create database directory'
  file:
    path: '{{ local_container_storage_path }}/plexmediaserver/db'
    state: 'directory'
    owner: '{{ docker_runtime_user_name }}'
    group: '{{ docker_runtime_group_name }}'
    mode: '0755'

- name: 'Create web-proxy docker network'
  docker_network:
    name: 'web-proxy'
    state: 'present'

- name: 'Create the Plex Media Server container'
  docker_container:
    name: 'plexmediaserver'
    image: 'plexinc/pms-docker:{{ plex_image_tag }}'
    restart_policy: 'unless-stopped'
    networks:
      - name: 'web-proxy'
    ports:
      - '32400:32400/tcp'
      - '3005:3005/tcp'
      - '8324:8324/tcp'
      - '32469:32469/tcp'
      - '1900:1900/udp'
      - '32410:32410/udp'
      - '32412:32412/udp'
      - '32413:32413/udp'
      - '32414:32414/udp'
    volumes:
      - '{{ local_container_storage_path }}/plexmediaserver/db:/config:z'
      - '{{ nfs_mount_path }}/medias:/data:slave,z'
    env:
      TZ: '{{ timezone }}'
      PLEX_UID: '{{ docker_runtime_user_id }}'
      PLEX_GID: '{{ docker_runtime_group_id }}'
      PLEX_CLAIM: '{{ plex_claim_token }}'
    labels:
      traefik.enable: 'true'
      traefik.docker.network: 'web-proxy'
      traefik.port: '32400'
      traefik.frontend.rule: 'Host:plex.{{ domain_name }}'
    purge_networks: yes
    pull: yes
    state: 'started'
