---
- name: 'Configure TOTP settings for the admin user'
  ansible.builtin.template:
    src: 'google-authenticator.j2'
    dest: '/home/{{ admin_user.user.name }}/.ssh/.google_authenticator'
    owner: '{{ admin_user.user.name }}'
    group: '{{ admin_user.user.name }}'
    mode: '0400'

- name: 'Enable password and challengeresponse authentication for SSH connections'
  ansible.builtin.copy:
    content: '{{ item.content }}'
    dest: '/etc/ssh/sshd_config.d/{{ item.file }}'
    owner: 'root'
    group: 'root'
    mode: '0644'
  loop:
    - content: 'PasswordAuthentication yes'
      file: '02-enable-passwords.conf'
    - content: 'ChallengeResponseAuthentication yes'
      file: '03-enable-totp.conf'
  notify: 'Restart sshd service'

- name: 'Enable google-authenticator PAM module for SSH connections'
  ansible.builtin.lineinfile:
    path: '/etc/pam.d/sshd'
    search_string: 'pam_google_authenticator.so'
    line: 'auth       required     pam_google_authenticator.so secret=/home/${USER}/.ssh/.google_authenticator'
    state: 'present'
  notify: 'Restart sshd service'
