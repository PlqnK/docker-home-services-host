---
- name: 'Create systemd mount units'
  ansible.builtin.template:
    src: 'systemd.mount.j2'
    dest: '/etc/systemd/system/{{ autofs_base_path | systemd_escape(path=True) }}-{{ item | systemd_escape(path=True) }}.mount'
    owner: 'root'
    group: 'root'
    mode: '0644'
  loop: '{{ nfs_exports }}'
  notify: 'Reload systemd daemon'

- name: 'Create systemd automount units'
  ansible.builtin.template:
    src: 'systemd.automount.j2'
    dest: '/etc/systemd/system/{{ autofs_base_path | systemd_escape(path=True) }}-{{ item | systemd_escape(path=True) }}.automount'
    owner: 'root'
    group: 'root'
    mode: '0644'
  loop: '{{ nfs_exports }}'
  notify: 'Reload systemd daemon'

- name: 'Flush handlers'
  meta: 'flush_handlers'

- name: 'Enable and start systemd automount units'
  ansible.builtin.systemd:
    name: '{{ autofs_base_path | systemd_escape(path=True) }}-{{ item | systemd_escape(path=True) }}.automount'
    enabled: true
    state: 'started'
  loop: '{{ nfs_exports }}'
