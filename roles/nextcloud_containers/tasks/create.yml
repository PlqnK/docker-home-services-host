---
- name: 'Check if provisioning a Vagrant VM'
  ansible.builtin.getent:
    database: 'passwd'
    key: 'vagrant'
    fail_key: false

- name: 'Create Nextcloud CNAME record'
  community.general.gandi_livedns:
    api_key: '{{ gandi_api_key }}'
    domain: '{{ domain_name }}'
    type: 'CNAME'
    record: 'cloud'
    values:
      - '{{ ansible_hostname }}'
    ttl: 10800
    state: 'present'
  when: (getent_passwd.vagrant is none)
  delegate_to: 'localhost'

- name: 'Create Nextcloud stack networks'
  containers.podman.podman_network:
    name: '{{ item.name }}'
    internal: '{{ item.internal }}'
    ipv6: '{{ containers_ipv6.enable }}'
  loop:
    - name: 'nextcloud-mariadb-internal'
      internal: true
    - name: 'nextcloud-redis-internal'
      internal: true
  tags: ['containers-networks']

- name: 'Add Nextcloud stack networks to firewalld trusted zone'
  tags: ['containers-networks']
  block:
    - name: 'Get podman networks info'
      containers.podman.podman_network_info:
        name: '{{ item }}'
      loop:
        - 'nextcloud-mariadb-internal'
        - 'nextcloud-redis-internal'
      register: 'podman_networks'

    - name: 'Add podman networks subnets to firewalld trusted zone'
      ansible.posix.firewalld:
        source: '{{ item }}'
        zone: 'trusted'
        permanent: true
        immediate: true
        state: 'enabled'
      loop: '{{ podman_networks.results | community.general.json_query("[*].networks[*].subnets[*].subnet") | ansible.builtin.flatten }}'

- name: 'Create Nextcloud stack bind mounts paths'
  ansible.builtin.file:
    path: '{{ item.path }}'
    owner: '{{ item.owner }}'
    group: '{{ item.group }}'
    mode: '{{ item.mode }}'
    state: 'directory'
  loop:
    - path: '{{ containers_storage_base_path }}/runtime/nextcloud-mariadb'
      owner: 999
      group: 999
      mode: '0700'
    - path: '{{ containers_storage_base_path }}/data/nextcloud-mariadb'
      owner: 'root'
      group: 'root'
      mode: '0700'
    - path: '{{ containers_storage_base_path }}/data/nextcloud-app'
      owner: 33
      group: 33
      mode: '0700'

- name: 'Create Nextcloud stack secrets'
  containers.podman.podman_secret:
    name: '{{ item.name }}'
    data: '{{ item.data }}'
    skip_existing: true
    state: 'present'
  loop:
    - name: 'nextcloud_mariadb_root_password'
      data: '{{ nextcloud.mariadb.root_password }}'
    - name: 'nextcloud_mariadb_user'
      data: '{{ nextcloud.mariadb.user }}'
    - name: 'nextcloud_mariadb_password'
      data: '{{ nextcloud.mariadb.password }}'
    - name: 'nextcloud_redis_password'
      data: '{{ nextcloud.redis.password }}'

- name: 'Create MariaDB container'
  containers.podman.podman_container:
    name: 'nextcloud-mariadb'
    image: '{{ containers_images.nextcloud.mariadb }}:{{ containers_images_tags.nextcloud.mariadb }}'
    command: '--transaction-isolation=READ-COMMITTED --binlog-format=ROW'
    network:
      - 'nextcloud-mariadb-internal'
    expose:
      - 3306
    volume:
      - '{{ containers_storage_base_path }}/runtime/nextcloud-mariadb:/var/lib/mysql:Z'
      - '{{ containers_storage_base_path }}/data/nextcloud-mariadb:/opt/dumps:Z'
    secrets:
      - 'nextcloud_mariadb_root_password'
      - 'nextcloud_mariadb_user'
      - 'nextcloud_mariadb_password'
    timezone: '{{ timezone }}'
    env:
      TZ: '{{ timezone }}'
      MARIADB_ROOT_HOST: 'localhost'
      MARIADB_ROOT_PASSWORD_FILE: '/run/secrets/nextcloud_mariadb_root_password'
      MARIADB_DATABASE: '{{ nextcloud.mariadb.database }}'
      MARIADB_USER_FILE: '/run/secrets/nextcloud_mariadb_user'
      MARIADB_PASSWORD_FILE: '/run/secrets/nextcloud_mariadb_password'
      MARIADB_AUTO_UPGRADE: 'true'
    label:
      deck-chores.dump.command: 'sh -c "mysqldump --single-transaction --default-character-set=utf8mb4 -u {{ nextcloud.mariadb.user }} -p{{ nextcloud.mariadb.password }} {{ nextcloud.mariadb.database }} > /opt/dumps/nextcloud.sql"'
      deck-chores.dump.cron: '* * * * * 4 0 0'
    generate_systemd:
      names: true
      new: true
      path: '/etc/systemd/system'
      restart_policy: 'on-failure'
    state: 'created'

- name: 'Create Redis container'
  containers.podman.podman_container:
    name: 'nextcloud-redis'
    image: '{{ containers_images.nextcloud.redis }}:{{ containers_images_tags.nextcloud.redis }}'
    command: '--requirepass {{ nextcloud.redis.password }}'
    timezone: '{{ timezone }}'
    network:
      - 'nextcloud-redis-internal'
    expose:
      - 6379
    env:
      TZ: '{{ timezone }}'
    generate_systemd:
      names: true
      new: true
      path: '/etc/systemd/system'
      restart_policy: 'on-failure'
    state: 'created'

- name: 'Create App container'
  containers.podman.podman_container:
    name: 'nextcloud-app'
    image: '{{ containers_images.nextcloud.app }}:{{ containers_images_tags.nextcloud.app }}'
    timezone: '{{ timezone }}'
    network:
      - 'web-egress'
      - 'common-internal'
      - 'nextcloud-mariadb-internal'
      - 'nextcloud-redis-internal'
    expose:
      - 80
    volume:
      - '{{ containers_storage_base_path }}/data/nextcloud-app:/var/www/html:z'
      - '{{ autofs_base_path }}/cloud/data:/var/www/html/data:slave'
    secrets:
      - 'nextcloud_mariadb_user'
      - 'nextcloud_mariadb_password'
      - 'nextcloud_redis_password'
    env:
      TZ: '{{ timezone }}'
      APACHE_DISABLE_REWRITE_IP: '1'
      TRUSTED_PROXIES: '10.89.0.0/16'
      NEXTCLOUD_TRUSTED_DOMAINS: 'cloud.{{ domain_name }}'
      NEXTCLOUD_INIT_HTACCESS: 'true'
      OVERWRITEPROTOCOL: 'https'
      OVERWRITECLIURL: 'https://cloud.{{ domain_name }}'
      MYSQL_HOST: 'nextcloud-mariadb'
      MYSQL_DATABASE: '{{ nextcloud.mariadb.database }}'
      MYSQL_USER_FILE: '/run/secrets/nextcloud_mariadb_user'
      MYSQL_PASSWORD_FILE: '/run/secrets/nextcloud_mariadb_password'
      REDIS_HOST: 'nextcloud-redis'
      REDIS_HOST_PASSWORD_FILE: '/run/secrets/nextcloud_redis_password'
    label:
      traefik.enable: 'true'
      traefik.docker.network: 'common-internal'
      traefik.http.routers.cloud.rule: 'Host(`cloud.{{ domain_name }}`)'
      traefik.http.routers.cloud.entrypoints: 'websecure'
      traefik.http.routers.cloud.middlewares: 'set-security-headers@file, nextcloud-dav-redirect'
      traefik.http.services.cloud.loadbalancer.server.port: '80'
      traefik.http.middlewares.nextcloud-dav-redirect.redirectRegex.permanent: 'true'
      traefik.http.middlewares.nextcloud-dav-redirect.redirectRegex.regex: 'https://(.*)/.well-known/(card|cal)dav'
      traefik.http.middlewares.nextcloud-dav-redirect.redirectRegex.replacement: 'https://${1}/remote.php/dav/'
    generate_systemd:
      names: true
      new: true
      path: '/etc/systemd/system'
      restart_policy: 'on-failure'
      after:
        - 'container-nextcloud-mariadb.service'
        - 'container-nextcloud-redis.service'
      requires:
        - 'container-nextcloud-mariadb.service'
        - 'container-nextcloud-redis.service'
    state: 'created'

- name: 'Create Cron container'
  containers.podman.podman_container:
    name: 'nextcloud-cron'
    image: '{{ containers_images.nextcloud.app }}:{{ containers_images_tags.nextcloud.app }}'
    entrypoint: '/cron.sh'
    timezone: '{{ timezone }}'
    network:
      - 'web-egress'
      - 'common-internal'
      - 'nextcloud-mariadb-internal'
      - 'nextcloud-redis-internal'
    volume:
      - '{{ containers_storage_base_path }}/data/nextcloud-app:/var/www/html:z'
      - '{{ autofs_base_path }}/cloud/data:/var/www/html/data:slave'
    env:
      TZ: '{{ timezone }}'
    generate_systemd:
      names: true
      new: true
      path: '/etc/systemd/system'
      restart_policy: 'on-failure'
      after:
        - 'container-nextcloud-app.service'
      requires:
        - 'container-nextcloud-app.service'
    state: 'created'

- name: 'Enable and start Nextcloud stack'
  ansible.builtin.systemd:
    name: '{{ item }}'
    daemon_reload: true
    enabled: true
    state: 'started'
  loop:
    - 'container-nextcloud-mariadb.service'
    - 'container-nextcloud-redis.service'
    - 'container-nextcloud-app.service'
    - 'container-nextcloud-cron.service'
